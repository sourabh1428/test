name: Deploy Node.js app to Azure VM - MarketMe

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4  # Check out the code from the repository

      - name: Install SSH Client
        run: sudo apt-get install -y openssh-client

      - name: Copy files via SCP
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > private_key
          chmod 600 private_key
          # Specify the files or directories to copy
          scp -i private_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./* azureuser@40.78.122.33:/home/azureuser/

      - name: SSH to VM and run the application
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > private_key
          chmod 600 private_key
          ssh -i private_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@40.78.122.33 << 'EOF'
            cd /home/azureuser
            
            # Inject environment variables from GitHub secrets
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export MONGODB_URI=${{ secrets.MONGODB_URI }}
            export NAME=${{ secrets.NAME }}
            export PORT=${{ secrets.PORT }}
            export REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

            # Install npm packages if necessary
            npm install --production

            # Start the application using PM2
            pm2 start index.js --name marketme || pm2 restart marketme
          EOF

      - name: Notify Deployment
        run: |
          echo "Deployed to Azure VM"
          echo "Deployment completed at $(date)"
